# 대시보드 통합 완료 문서

## ✅ 완료된 작업

### 1. 안전한 분리 구조

**기존 파일 수정 없음:**

- ✅ `FirebaseUtils.js` - 그대로 유지
- ✅ 기존 `useEffect` 로직 - 그대로 유지 (조건부로 실행)

**새로 추가된 기능:**

- ✅ 통합 모드 전환 (설문 유형 선택)
- ✅ 통합 환자 조회
- ✅ 통합 상담 요청 조회
- ✅ 통합 통계 계산
- ✅ 타입별 컬렉션 자동 선택

---

### 2. 구현된 기능

#### 설문 유형 선택 필터

- **생존자 설문** (기본값) - 기존 동작 유지
- **환자 설문** - web3 데이터만 조회
- **전체** - 생존자 + 환자 모두 조회

#### 통합 환자 목록

- 타입 배지 표시 (생존자/환자 구분)
- 통합 필터링 (위험도, 암 종류 등)
- 통합 통계 (전체/생존자/환자별)

#### 통합 상담 요청

- 두 설문의 상담 요청 통합 조회
- 타입별 컬렉션 자동 선택

#### 상담 상태 업데이트

- 환자 타입에 따라 올바른 컬렉션에 저장
- `patients` 또는 `patients_patients` 자동 선택
- `counselingRequests` 또는 `patients_counselingRequests` 자동 선택

#### 보관 기능

- 환자 타입에 따라 올바른 컬렉션에 저장

---

### 3. 동작 방식

#### 기본 모드 (생존자만)

```javascript
surveyType = SURVEY_TYPES.SURVIVOR
→ 기존 useEffect 실행
→ collection(db, "patients") 조회
→ 기존 로직 그대로 동작
```

#### 통합 모드 (환자 또는 전체)

```javascript
surveyType = SURVEY_TYPES.PATIENT | SURVEY_TYPES.ALL
→ 통합 useEffect 실행
→ subscribeIntegratedPatients() 사용
→ 두 컬렉션 병렬 조회
```

---

### 4. UI 변경사항

#### 필터 바에 추가

- **설문 유형** 선택 드롭다운
  - 생존자 설문 (기본)
  - 환자 설문
  - 전체

#### 환자 테이블에 추가

- **유형** 컬럼 (통합 모드일 때만 표시)
  - 생존자 배지 (초록색)
  - 환자 배지 (주황색)

---

### 5. 안전성 보장

#### 기존 코드 보호

- ✅ `if (useIntegratedMode) return;` - 통합 모드면 기존 useEffect 실행 안 함
- ✅ `if (!useIntegratedMode) return;` - 기존 모드면 통합 useEffect 실행 안 함
- ✅ 기본값: `SURVEY_TYPES.SURVIVOR` - 기존 동작 유지

#### 컬렉션 분리

- ✅ 생존자: `patients`, `users`, `counselingRequests`
- ✅ 환자: `patients_patients`, `patients_users`, `patients_counselingRequests`
- ✅ 자동 선택: 환자 타입에 따라 올바른 컬렉션 사용

---

### 6. 사용 방법

#### 기본 사용 (기존 동작)

1. 대시보드 접속
2. "설문 유형" 필터에서 "생존자 설문" 선택 (기본값)
3. → 기존처럼 생존자 데이터만 표시

#### 통합 사용

1. 대시보드 접속
2. "설문 유형" 필터에서 "환자 설문" 또는 "전체" 선택
3. → 환자 데이터 또는 전체 데이터 표시
4. → 유형 컬럼에 배지 표시

---

### 7. 테스트 체크리스트

#### 기본 모드 테스트

- [ ] "생존자 설문" 선택 시 기존 데이터만 표시
- [ ] 유형 컬럼이 표시되지 않음
- [ ] 통계가 생존자 기준으로 계산됨

#### 통합 모드 테스트

- [ ] "환자 설문" 선택 시 환자 데이터만 표시
- [ ] "전체" 선택 시 생존자 + 환자 모두 표시
- [ ] 유형 컬럼에 배지 표시
- [ ] 통계가 선택한 유형에 맞게 계산됨
- [ ] 상담 상태 업데이트가 올바른 컬렉션에 저장됨
- [ ] 보관 기능이 올바른 컬렉션에 저장됨

---

### 8. 주의사항

#### ID 충돌

- 같은 이름+생년월일로 생성된 ID가 다를 수 있음
- 해결: `type` 필드로 구분

#### 데이터 구조 차이

- 생존자와 환자의 설문 구조가 다를 수 있음
- 상세 페이지에서 타입별로 다른 컴포넌트 렌더링 필요할 수 있음

#### 성능

- 통합 모드에서는 두 컬렉션을 병렬 조회
- 네트워크 요청이 증가할 수 있음

---

## 📋 파일 변경 요약

### 수정된 파일

- `web2/src/pages/DashboardPage.js`
  - 통합 기능 import 추가
  - 설문 유형 상태 추가
  - 통합 모드 useEffect 추가 (기존 useEffect는 조건부 실행)
  - 필터 바에 설문 유형 선택 추가
  - 테이블에 유형 컬럼 추가
  - 상담 상태/보관 업데이트 시 컬렉션 자동 선택

### 새로 생성된 파일

- `web2/src/utils/collectionConfig.js`
- `web2/src/utils/IntegratedFirebaseUtils.js`
- `web2/INTEGRATION_GUIDE.md`
- `web2/SAFETY_GUARANTEE.md`
- `web2/DASHBOARD_INTEGRATION_COMPLETE.md`

---

## ✅ 완료 상태

- [x] 컬렉션 분리 설정
- [x] 통합 유틸 함수 생성
- [x] DashboardPage 통합 기능 추가
- [x] 설문 유형 필터 추가
- [x] 타입 배지 표시
- [x] 통합 통계 계산
- [x] 상담 상태 업데이트 통합
- [x] 보관 기능 통합
- [x] 안전성 보장 (기존 코드 영향 없음)

---

**작성일**: 2024년
**상태**: ✅ 대시보드 통합 완료
